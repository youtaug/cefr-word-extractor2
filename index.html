<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEFRèªå¥æŠ½å‡ºãƒ„ãƒ¼ãƒ«</title>
    <style>
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f9f9f9;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #ddd;
            --button-primary: #4CAF50;
            --button-hover: #45a049;
            --level-a1: #2196F3;
            --level-a2: #4CAF50;
            --level-b1: #FF9800;
            --level-b2: #F44336;
            --highlight-a1: rgba(33, 150, 243, 0.2);
            --highlight-a2: rgba(76, 175, 80, 0.2);
            --highlight-b1: rgba(255, 152, 0, 0.2);
            --highlight-b2: rgba(244, 67, 54, 0.2);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #444;
            --button-primary: #4CAF50;
            --button-hover: #45a049;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            gap: 20px;
        }

        h1 {
            font-size: 24px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .theme-toggle {
            background: transparent;
            border: none;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 24px;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            transform: rotate(180deg);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-bar {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }

        .status-bar.loading {
            background: #fff3cd;
            color: #856404;
        }

        .status-bar.ready {
            background: #d4edda;
            color: #155724;
        }

        .status-bar.error {
            background: #f8d7da;
            color: #721c24;
        }

        .level-selector {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .level-selector label {
            margin-right: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .level-selector input[type="checkbox"] {
            margin-right: 5px;
        }

        textarea {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        textarea:focus {
            outline: none;
            border-color: var(--button-primary);
        }

        .highlighted-text {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.8;
            background: var(--bg-secondary);
            overflow-y: auto;
            max-height: 500px;
        }

        .word-highlight {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .word-highlight:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .level-a1-bg { background-color: var(--highlight-a1); color: var(--level-a1); font-weight: bold; }
        .level-a2-bg { background-color: var(--highlight-a2); color: var(--level-a2); font-weight: bold; }
        .level-b1-bg { background-color: var(--highlight-b1); color: var(--level-b1); font-weight: bold; }
        .level-b2-bg { background-color: var(--highlight-b2); color: var(--level-b2); font-weight: bold; }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        button {
            background: var(--button-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover:not(:disabled) {
            background: var(--button-hover);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .button-secondary {
            background: #2196F3;
        }

        .button-secondary:hover:not(:disabled) {
            background: #0b7dda;
        }

        .stats {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            font-size: 14px;
        }

        .stat-item {
            margin: 8px 0;
        }

        .stat-item strong {
            font-size: 18px;
        }

        .level-a1 { color: var(--level-a1); font-weight: bold; }
        .level-a2 { color: var(--level-a2); font-weight: bold; }
        .level-b1 { color: var(--level-b1); font-weight: bold; }
        .level-b2 { color: var(--level-b2); font-weight: bold; }

        .chart-container {
            margin: 20px 0;
            height: 300px;
            width: 100%;
            position: relative;
        }

        .chart-container canvas {
            max-height: 300px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            display: block;
            overflow-x: auto;
        }

        thead, tbody {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--button-primary);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: var(--bg-tertiary);
        }

        .loading {
            display: none;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        .results {
            margin-top: 20px;
            clear: both;
        }

        .results .panel {
            overflow: visible;
        }

        .hidden {
            display: none;
        }

        .legend {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: row;
                align-items: flex-start;
                justify-content: space-between;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .panel {
                padding: 15px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .subtitle {
                font-size: 12px;
            }
            
            .header {
                align-items: flex-start;
            }
            
            .theme-toggle {
                font-size: 20px;
                width: 36px;
                height: 36px;
            }
            
            .level-selector label {
                display: block;
                margin: 8px 0;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .chart-container {
                height: 250px;
            }
            
            table {
                font-size: 13px;
            }
            
            th, td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>CEFRèªå¥æŠ½å‡ºãƒ„ãƒ¼ãƒ«</h1>
                <div class="subtitle">CEFRJ Wordlist Ver1.6 æº–æ‹ ï¼ˆ6,863èªåéŒ²ï¼‰</div>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">ğŸŒ“</button>
        </div>

        <div class="status-bar loading" id="statusBar">
            è¾æ›¸ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
        </div>

        <div class="level-selector">
            <strong>æŠ½å‡ºã™ã‚‹ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠï¼š</strong><br><br>
            <label><input type="checkbox" id="level-a1" checked onchange="updatePreview()"> <span class="level-a1">A1</span></label>
            <label><input type="checkbox" id="level-a2" checked onchange="updatePreview()"> <span class="level-a2">A2</span></label>
            <label><input type="checkbox" id="level-b1" checked onchange="updatePreview()"> <span class="level-b1">B1</span></label>
            <label><input type="checkbox" id="level-b2" checked onchange="updatePreview()"> <span class="level-b2">B2</span></label>
        </div>

        <div class="main-content">
            <div class="panel">
                <h3>ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›</h3>
                <textarea id="inputText" placeholder="è¾æ›¸ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­..." disabled oninput="updatePreview()"></textarea>
                
                <div class="button-group">
                    <button onclick="analyzeText()" id="analyzeBtn" disabled>ğŸ“Š èªå¥ã‚’æŠ½å‡º</button>
                    <button class="button-secondary" onclick="clearText()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                </div>
            </div>

            <div class="panel">
                <h3>ğŸ¨ ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º</h3>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--highlight-a1);"></div>
                        <span class="level-a1">A1</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--highlight-a2);"></div>
                        <span class="level-a2">A2</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--highlight-b1);"></div>
                        <span class="level-b1">B1</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--highlight-b2);"></div>
                        <span class="level-b2">B2</span>
                    </div>
                </div>
                <div class="highlighted-text" id="highlightedText">
                    ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ã€é¸æŠã—ãŸãƒ¬ãƒ™ãƒ«ã®å˜èªãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã¾ã™ã€‚<br>
                    å˜èªã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è¾æ›¸ã§æ„å‘³ã‚’ç¢ºèªã§ãã¾ã™ã€‚
                </div>
                
                <div class="loading" id="loading">å‡¦ç†ä¸­...</div>
                
                <div class="stats" id="previewStats" style="display:none;">
                    <div class="stat-item">
                        <strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</strong>
                    </div>
                    <div class="stat-item" id="previewCount">
                        è©²å½“å˜èªæ•°: <strong>0</strong>èª
                    </div>
                </div>
            </div>
        </div>

        <div class="results hidden" id="results">
            <div class="panel">
                <h3>ğŸ“ˆ åˆ†æçµæœ</h3>
                
                <div class="stats" id="stats"></div>

                <div class="chart-container">
                    <canvas id="levelChart"></canvas>
                </div>

                <div class="button-group">
                    <button class="button-secondary" onclick="exportToCSV()" id="exportBtn">ğŸ“¥ CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <button class="button-secondary" onclick="copyResults()">ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
                </div>

                <table id="resultTable">
                    <thead>
                        <tr>
                            <th>å˜èª</th>
                            <th>CEFRãƒ¬ãƒ™ãƒ«</th>
                            <th>å‡ºç¾å›æ•°</th>
                            <th>è¾æ›¸</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        let cefrDatabase = {};
        let currentChart = null;
        let debounceTimer = null;
        
        const irregularVerbs = {
            'was': 'be', 'were': 'be', 'been': 'be', 'being': 'be',
            'had': 'have', 'has': 'have', 'having': 'have',
            'did': 'do', 'does': 'do', 'done': 'do', 'doing': 'do',
            'went': 'go', 'gone': 'go', 'going': 'go',
            'came': 'come', 'coming': 'come',
            'saw': 'see', 'seen': 'see', 'seeing': 'see',
            'took': 'take', 'taken': 'take', 'taking': 'take',
            'got': 'get', 'gotten': 'get', 'getting': 'get',
            'made': 'make', 'making': 'make',
            'knew': 'know', 'known': 'know', 'knowing': 'know',
            'thought': 'think', 'thinking': 'think',
            'found': 'find', 'finding': 'find',
            'gave': 'give', 'given': 'give', 'giving': 'give',
            'told': 'tell', 'telling': 'tell',
            'became': 'become', 'becoming': 'become',
            'left': 'leave', 'leaving': 'leave',
            'felt': 'feel', 'feeling': 'feel',
            'brought': 'bring', 'bringing': 'bring',
            'began': 'begin', 'begun': 'begin', 'beginning': 'begin',
            'kept': 'keep', 'keeping': 'keep',
            'held': 'hold', 'holding': 'hold',
            'wrote': 'write', 'written': 'write', 'writing': 'write',
            'stood': 'stand', 'standing': 'stand',
            'heard': 'hear', 'hearing': 'hear',
            'let': 'let', 'letting': 'let',
            'meant': 'mean', 'meaning': 'mean',
            'set': 'set', 'setting': 'set',
            'met': 'meet', 'meeting': 'meet',
            'ran': 'run', 'running': 'run',
            'paid': 'pay', 'paying': 'pay',
            'sat': 'sit', 'sitting': 'sit',
            'spoke': 'speak', 'spoken': 'speak', 'speaking': 'speak',
            'lay': 'lie', 'lain': 'lie', 'lying': 'lie',
            'led': 'lead', 'leading': 'lead',
            'read': 'read', 'reading': 'read',
            'grew': 'grow', 'grown': 'grow', 'growing': 'grow',
            'lost': 'lose', 'losing': 'lose',
            'fell': 'fall', 'fallen': 'fall', 'falling': 'fall',
            'sent': 'send', 'sending': 'send',
            'built': 'build', 'building': 'build',
            'understood': 'understand', 'understanding': 'understand',
            'drew': 'draw', 'drawn': 'draw', 'drawing': 'draw',
            'broke': 'break', 'broken': 'break', 'breaking': 'break',
            'spent': 'spend', 'spending': 'spend',
            'cut': 'cut', 'cutting': 'cut',
            'rose': 'rise', 'risen': 'rise', 'rising': 'rise',
            'drove': 'drive', 'driven': 'drive', 'driving': 'drive',
            'bought': 'buy', 'buying': 'buy',
            'wore': 'wear', 'worn': 'wear', 'wearing': 'wear',
            'chose': 'choose', 'chosen': 'choose', 'choosing': 'choose',
            'sought': 'seek', 'seeking': 'seek',
            'threw': 'throw', 'thrown': 'throw', 'throwing': 'throw',
            'caught': 'catch', 'catching': 'catch',
            'dealt': 'deal', 'dealing': 'deal',
            'sung': 'sing', 'sang': 'sing', 'singing': 'sing',
            'sold': 'sell', 'selling': 'sell',
            'taught': 'teach', 'teaching': 'teach',
            'won': 'win', 'winning': 'win',
            'hung': 'hang', 'hanging': 'hang',
            'struck': 'strike', 'striking': 'strike',
            'bore': 'bear', 'born': 'bear', 'bearing': 'bear',
            'beat': 'beat', 'beaten': 'beat', 'beating': 'beat'
        };

        // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // ãƒãƒ£ãƒ¼ãƒˆã‚’å†æç”»
            if (currentChart && window.currentResults) {
                createChart(window.currentResults);
            }
        }

        // ä¿å­˜ã•ã‚ŒãŸãƒ†ãƒ¼ãƒã‚’èª­ã¿è¾¼ã¿
        window.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            loadCSVData();
        });

        function loadCSVData() {
            const statusBar = document.getElementById('statusBar');
            
            fetch('cefrj-wordlist.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    return response.text();
                })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            try {
                                cefrDatabase = {};
                                
                                results.data.forEach(row => {
                                    if (row.headword && row.CEFR) {
                                        const word = String(row.headword).toLowerCase().trim();
                                        const level = String(row.CEFR).trim();
                                        cefrDatabase[word] = level;
                                    }
                                });
                                
                                const wordCount = Object.keys(cefrDatabase).length;
                                const levelCounts = {};
                                Object.values(cefrDatabase).forEach(level => {
                                    levelCounts[level] = (levelCounts[level] || 0) + 1;
                                });
                                
                                statusBar.className = 'status-bar ready';
                                statusBar.innerHTML = 
                                    `âœ“ æº–å‚™å®Œäº†ï¼š${wordCount}èªã®è¾æ›¸ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ ` +
                                    `(A1: ${levelCounts['A1'] || 0} | A2: ${levelCounts['A2'] || 0} | B1: ${levelCounts['B1'] || 0} | B2: ${levelCounts['B2'] || 0})`;
                                
                                document.getElementById('inputText').disabled = false;
                                document.getElementById('inputText').placeholder = 'é•·æ–‡ãƒ†ã‚­ã‚¹ãƒˆã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„...';
                                document.getElementById('analyzeBtn').disabled = false;
                                
                            } catch (error) {
                                statusBar.className = 'status-bar error';
                                statusBar.innerHTML = `ã‚¨ãƒ©ãƒ¼ï¼š${error.message}`;
                            }
                        }
                    });
                })
                .catch(error => {
                    statusBar.className = 'status-bar error';
                    statusBar.innerHTML = 
                        `ã‚¨ãƒ©ãƒ¼ï¼šCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ã€Œcefrj-wordlist.csvã€ãŒHTMLãƒ•ã‚¡ã‚¤ãƒ«ã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                });
        }

        function lemmatize(word) {
            word = word.toLowerCase();
            
            if (irregularVerbs[word]) {
                return irregularVerbs[word];
            }
            
            if (word.endsWith('ies') && word.length > 4) {
                return word.slice(0, -3) + 'y';
            }
            if (word.endsWith('ied') && word.length > 4) {
                return word.slice(0, -3) + 'y';
            }
            if (word.endsWith('es') && word.length > 3) {
                const base = word.slice(0, -2);
                if (base.endsWith('s') || base.endsWith('x') || base.endsWith('z') || 
                    base.endsWith('ch') || base.endsWith('sh')) {
                    return base;
                }
                return word.slice(0, -1);
            }
            if (word.endsWith('ed') && word.length > 3) {
                const base = word.slice(0, -2);
                if (base.length >= 2 && base[base.length-1] === base[base.length-2]) {
                    return base.slice(0, -1);
                }
                return base;
            }
            if (word.endsWith('ing') && word.length > 4) {
                const base = word.slice(0, -3);
                if (base.length >= 2 && base[base.length-1] === base[base.length-2]) {
                    return base.slice(0, -1);
                }
                if (!base.endsWith('e') && word.length > 5) {
                    return base + 'e';
                }
                return base;
            }
            if (word.endsWith('s') && word.length > 2 && !word.endsWith('ss') && !word.endsWith('us')) {
                return word.slice(0, -1);
            }
            
            return word;
        }

        function updatePreview() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const text = document.getElementById('inputText').value;
                if (!text.trim()) {
                    document.getElementById('highlightedText').innerHTML = 
                        'ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ã€é¸æŠã—ãŸãƒ¬ãƒ™ãƒ«ã®å˜èªãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã¾ã™ã€‚<br>å˜èªã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è¾æ›¸ã§æ„å‘³ã‚’ç¢ºèªã§ãã¾ã™ã€‚';
                    document.getElementById('previewStats').style.display = 'none';
                    return;
                }

                const selectedLevels = getSelectedLevels();
                if (selectedLevels.length === 0) {
                    document.getElementById('highlightedText').innerHTML = 
                        'ãƒ¬ãƒ™ãƒ«ã‚’å°‘ãªãã¨ã‚‚1ã¤é¸æŠã—ã¦ãã ã•ã„ã€‚';
                    document.getElementById('previewStats').style.display = 'none';
                    return;
                }

                const highlightedHtml = highlightText(text, selectedLevels);
                document.getElementById('highlightedText').innerHTML = highlightedHtml;
                
                // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º
                const count = (highlightedHtml.match(/class="word-highlight/g) || []).length;
                document.getElementById('previewCount').innerHTML = 
                    `è©²å½“å˜èªæ•°: <strong>${count}</strong>èª`;
                document.getElementById('previewStats').style.display = 'block';
            }, 300);
        }

        function highlightText(text, selectedLevels) {
            const words = text.split(/(\s+|[.,!?;:()"\[\]{}])/);
            
            return words.map(token => {
                if (/^\s+$/.test(token) || /^[.,!?;:()"\[\]{}]$/.test(token)) {
                    return token;
                }
                
                const word = token.replace(/^[^a-zA-Z]+|[^a-zA-Z]+$/g, '');
                if (word.length < 3) return token;
                
                // å›ºæœ‰åè©ãƒã‚§ãƒƒã‚¯
                if (/^[A-Z]+$/.test(word) || 
                    (word[0] === word[0].toUpperCase() && 
                     word.length > 1 && 
                     word[1] === word[1].toUpperCase())) {
                    return token;
                }
                
                const lemma = lemmatize(word);
                const level = cefrDatabase[lemma];
                
                if (level && selectedLevels.includes(level)) {
                    return `<span class="word-highlight level-${level.toLowerCase()}-bg" onclick="openDictionary('${word}')" title="${level}">${token}</span>`;
                }
                
                return token;
            }).join('');
        }

        function getSelectedLevels() {
            const levels = [];
            if (document.getElementById('level-a1').checked) levels.push('A1');
            if (document.getElementById('level-a2').checked) levels.push('A2');
            if (document.getElementById('level-b1').checked) levels.push('B1');
            if (document.getElementById('level-b2').checked) levels.push('B2');
            return levels;
        }

        function openDictionary(word) {
            window.open(`https://ejje.weblio.jp/content/${encodeURIComponent(word)}`, '_blank');
        }

        function clearText() {
            document.getElementById('inputText').value = '';
            document.getElementById('highlightedText').innerHTML = 
                'ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ã€é¸æŠã—ãŸãƒ¬ãƒ™ãƒ«ã®å˜èªãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã¾ã™ã€‚<br>å˜èªã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è¾æ›¸ã§æ„å‘³ã‚’ç¢ºèªã§ãã¾ã™ã€‚';
            document.getElementById('previewStats').style.display = 'none';
            document.getElementById('results').classList.add('hidden');
        }

        function analyzeText() {
            const inputText = document.getElementById('inputText').value.trim();
            
            if (!inputText) {
                alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (Object.keys(cefrDatabase).length === 0) {
                alert('è¾æ›¸ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            const selectedLevels = getSelectedLevels();
            
            if (selectedLevels.length === 0) {
                alert('å°‘ãªãã¨ã‚‚1ã¤ã®ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').classList.add('hidden');
            
            setTimeout(() => {
                processText(inputText, selectedLevels);
            }, 100);
        }

        function processText(text, selectedLevels) {
            const words = text.match(/[a-z][a-z']*|[A-Z][a-z][a-z']*/g) || [];
            
            const wordMap = {};
            
            words.forEach(originalWord => {
                if (/^[A-Z]+$/.test(originalWord) || 
                    (originalWord[0] === originalWord[0].toUpperCase() && 
                     originalWord.length > 1 && 
                     originalWord[1] === originalWord[1].toUpperCase())) {
                    return;
                }
                
                const word = originalWord.toLowerCase();
                if (word.length < 3) return;
                
                const lemma = lemmatize(word);
                
                if (cefrDatabase[lemma]) {
                    const level = cefrDatabase[lemma];
                    
                    if (selectedLevels.includes(level)) {
                        if (!wordMap[lemma]) {
                            wordMap[lemma] = {
                                count: 0,
                                level: level
                            };
                        }
                        wordMap[lemma].count++;
                    }
                }
            });
            
            const results = Object.entries(wordMap)
                .map(([word, data]) => ({
                    word: word,
                    level: data.level,
                    count: data.count
                }))
                .sort((a, b) => {
                    const levelOrder = { 'A1': 1, 'A2': 2, 'B1': 3, 'B2': 4 };
                    const levelDiff = (levelOrder[b.level] || 0) - (levelOrder[a.level] || 0);
                    if (levelDiff !== 0) return levelDiff;
                    return b.count - a.count;
                });
            
            displayResults(results);
            createChart(results);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').classList.remove('hidden');
            
            window.currentResults = results;
        }

        function displayResults(results) {
            const totalCount = results.length;
            const totalOccurrences = results.reduce((sum, r) => sum + r.count, 0);
            
            const levelCounts = {};
            results.forEach(r => {
                levelCounts[r.level] = (levelCounts[r.level] || 0) + 1;
            });
            
            let statsHTML = `
                <div class="stat-item">
                    <div>æŠ½å‡ºã•ã‚ŒãŸå˜èªæ•°ï¼š<strong>${totalCount}</strong> èªï¼ˆå»¶ã¹ ${totalOccurrences} å›å‡ºç¾ï¼‰</div>
                </div>
                <div class="stat-item" style="margin-top:10px;">
            `;
            
            ['A1', 'A2', 'B1', 'B2'].forEach(level => {
                if (levelCounts[level]) {
                    statsHTML += `<span class="level-${level.toLowerCase()}">${level}: ${levelCounts[level]}èª</span> &nbsp; `;
                }
            });
            
            statsHTML += `</div>`;
            
            document.getElementById('stats').innerHTML = statsHTML;
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            results.forEach(item => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = item.word;
                const levelCell = row.insertCell(1);
                levelCell.innerHTML = `<span class="level-${item.level.toLowerCase()}">${item.level}</span>`;
                row.insertCell(2).textContent = item.count;
                const dictCell = row.insertCell(3);
                dictCell.innerHTML = `<button class="button-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="openDictionary('${item.word}')">ğŸ” è¾æ›¸</button>`;
            });
        }

        function createChart(results) {
            const ctx = document.getElementById('levelChart');
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            const levelCounts = { 'A1': 0, 'A2': 0, 'B1': 0, 'B2': 0 };
            results.forEach(r => {
                levelCounts[r.level] = (levelCounts[r.level] || 0) + 1;
            });
            
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#e0e0e0' : '#333';
            
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['A1', 'A2', 'B1', 'B2'],
                    datasets: [{
                        label: 'å˜èªæ•°',
                        data: [levelCounts.A1, levelCounts.A2, levelCounts.B1, levelCounts.B2],
                        backgroundColor: [
                            'rgba(33, 150, 243, 0.7)',
                            'rgba(76, 175, 80, 0.7)',
                            'rgba(255, 152, 0, 0.7)',
                            'rgba(244, 67, 54, 0.7)'
                        ],
                        borderColor: [
                            'rgba(33, 150, 243, 1)',
                            'rgba(76, 175, 80, 1)',
                            'rgba(255, 152, 0, 1)',
                            'rgba(244, 67, 54, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'CEFRãƒ¬ãƒ™ãƒ«åˆ¥èªå½™æ•°',
                            color: textColor,
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: textColor,
                                stepSize: 1
                            },
                            grid: {
                                color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function copyResults() {
            if (!window.currentResults) {
                alert('ã¾ãšãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æã—ã¦ãã ã•ã„');
                return;
            }
            
            let text = 'ã€CEFRèªå¥æŠ½å‡ºçµæœã€‘\n\n';
            text += 'å˜èª\tCEFRãƒ¬ãƒ™ãƒ«\tå‡ºç¾å›æ•°\n';
            text += '----------------------------------------\n';
            
            window.currentResults.forEach(item => {
                text += `${item.word}\t${item.level}\t${item.count}\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                alert('çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            }).catch(err => {
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
            });
        }

        function exportToCSV() {
            if (!window.currentResults) {
                alert('ã¾ãšãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æã—ã¦ãã ã•ã„');
                return;
            }
            
            let csv = '\uFEFF';
            csv += 'å˜èª,CEFRãƒ¬ãƒ™ãƒ«,å‡ºç¾å›æ•°\n';
            
            window.currentResults.forEach(item => {
                csv += `"${item.word}","${item.level}",${item.count}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'cefr_words_' + new Date().getTime() + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
